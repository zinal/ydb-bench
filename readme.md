# YDB Bench - Инструмент для нагрузочного тестирования в стиле pgbench

Инструмент для запуска нагрузочных тестов в стиле pgbench для баз данных YDB.

## Установка

### C использованием pipx 

```bash
# Установка c github
pipx install git+https://github.com/senjaster/ydb-bench

# Или установка в режиме разработки
pipx install -e .
```

### Использование pip

```bash
# Активация виртуального окружения
source .venv/bin/activate

# Установка пакета
pip install -e .
```

## Конфигурация

Инструмент поддерживает конфигурацию через переменные окружения с возможностью переопределения через параметры командной строки.

### Переменные окружения

- `YDB_ENDPOINT` - Эндпоинт YDB (например, `grpcs://ydb-host:2135`)
- `YDB_DATABASE` - Путь к базе данных (например, `/Root/database`)
- `YDB_ROOT_CERT` - Путь к файлу корневого сертификата (опционально)
- `YDB_USER` - Имя пользователя для аутентификации (опционально)
- `YDB_PASSWORD` - Пароль для аутентификации (опционально)
- `YDB_PREFIX_PATH` - Имя папки для таблиц (по умолчанию: pgbench)

### Пример настройки окружения

```bash
export YDB_ENDPOINT="grpcs://ydb-node-1.ydb-cluster.com:2135"
export YDB_DATABASE="/Root/database"
export YDB_ROOT_CERT="./ca.crt"
export YDB_USER="your_user"
export YDB_PASSWORD="your_password"
```

## Использование

### Инициализация базы данных

Создание таблиц и заполнение тестовыми данными:

```bash
# Использование переменных окружения
ydb-bench init --scale 100

# Использование параметров командной строки (переопределяет переменные окружения)
ydb-bench init \
  --endpoint "grpcs://ydb-host:2135" \
  --database "/Root/database" \
  --ca-file "./ca.crt" \
  --user "root" \
  --password "your_password" \
  --scale 100
```

**Параметры:**
- `--scale` / `-s` - Множитель к количеству строк в таблицах (по умолчанию: 100)
- `--prefix-path` - Имя папки для таблиц (по умолчанию: pgbench)

### Запуск нагрузочного теста

Выполнение транзакций tpcb-like из pgbench:

```bash
# Использование переменных окружения
ydb-bench run --jobs 100 --transactions 1000

# Использование параметров командной строки
ydb-bench run \
  --endpoint "grpcs://ydb-host:2135" \
  --database "/Root/database" \
  --ca-file "./ca.crt" \
  --user "root" \
  --password "your_password" \
  --jobs 100 \
  --transactions 1000

# С несколькими клиентскими процессами
ydb-bench run --processes 4 --jobs 25 --transactions 1000

# Использование пользовательского SQL-скрипта
ydb-bench run --jobs 10 --transactions 100 --file custom_script.sql
```

**Параметры:**
- `--processes` - Количество параллельных клиентских процессов (по умолчанию: 1)
- `--jobs` / `-j` - Количество параллельных задач на процесс (по умолчанию: 1). Каждая задача использует отдельное соединение.
- `--transactions` / `-t` - Количество транзакций, выполняемых каждой задачей (по умолчанию: 100)
- `--single-session` - Использовать одну постоянную сессию на задачу вместо запроса сессии из пула каждый раз
- `--file` / `-f` - Путь к файлу с SQL-скриптом для выполнения


## Использование параметров в пользовательских SQL-скриптах

При создании пользовательских SQL-скриптов вы можете использовать следующие параметры, которые автоматически генерируются для каждой транзакции:

### Доступные параметры

- **`$bid`** - (branch ID), генерируется случайное значение в диапазоне от 1 до значения, переданного в  параметр `--scale`
- **`$tid`** - (teller ID), вычисляется как `(bid - 1) * 10 + randint(1, 10)`
- **`$aid`** - (account ID), вычисляется как `(bid - 1) * 100000 + randint(1, 100000)`
- **`$delta`** - Случайное значение от 1 до 1000
- **`$iteration`** - Номер текущей итерации (начиная с 0). Номер итерации уникален только в рамках одного соединения

### table_folder 
Используйте плейсхолдер {table_folder} для имени папки, в которой находятся таблицы. Он будет автоматически заменен на значение параметра --prefix-path (см пример ниже)

### Пример пользовательского скрипта

```sql
-- Простой скрипт обновления баланса счета
UPDATE `{table_folder}/accounts`
SET abalance = abalance + $delta - 100
WHERE aid = $aid;
```

## Режимы выполнения

### С использованием пула
Использует пул сессий YDB с автоматической логикой повторных попыток. Подходит для большинства нагрузок.

### Режим одной сессии
Использует одну полученную сессию для всех операций. Может быть быстрее. Экспериментальный режим.

```bash
ydb-bench run --single-session --jobs 10 --transactions 100
```

## Использование нескольких процессов

Когда `--processes` установлен в 1 (по умолчанию), инструмент работает в однопроцессном режиме, используя async/await для параллелизма.

Когда `--processes` больше 1, инструмент использует многопроцессность Python для запуска нескольких процессов параллельно, каждый со своим набором асинхронных задач.


## Количество соединений

Инструмент создает соединения с базой данных на основе двух параметров:

- **Джобы (`--jobs`)**: Количество параллельно выполняющихся джобов внутри каждого процесса. Каждый джоб использует собственное соединение с базой данных.
- **Процессы (`--processes`)**: Количество независимых процессов Python, работающих параллельно. Каждый процесс имеет свой набор задач.

**Формула общего количества соединений:**
```
Общее количество соединений = jobs × processes
```

### Примеры

| Процессы | Джобы  | Общее количество соединений |
|----------|--------|-----------------------------|
| 1        | 10     | 10                          |
| 4        | 25     | 100                         |
| 8        | 50     | 400                         |

### Рекомендации по настройке

1. **Начните с количества джобов**: Сначала увеличивайте `--jobs`, пока использование CPU процессом не достигнет ~80-90%
   - Типичный диапазон: 10-100 джобов на процесс
   - Чем медленнее выполняется транзакция, тем больше джобов может обслуживать один процесс

2. **Масштабируйте процессами**: Как только один процесс насыщен по CPU, увеличивайте `--processes` для увеличения нагрузки соединений
   - Каждый процесс работает независимо со своим собственным циклом событий
   - Распределяет нагрузку между несколькими ядрами CPU

3. **Пример пути масштабирования**:
   ```bash
   # Шаг 1: Найдите оптимальное количество задач на процесс
   ydb-bench run --jobs 10 --transactions 1000   # Мониторьте CPU
   ydb-bench run --jobs 25 --transactions 1000   # Увеличивайте до ~90% CPU
   
   # Шаг 2: Масштабируйте горизонтально с процессами
   ydb-bench run --processes 4 --jobs 25 --transactions 1000  # 100 соединений всего
   ```
   Количество процессов не должно превышать количество ядер CPU.

## Примеры

```bash
# Инициализация с 50 бранчами
ydb-bench init --scale 50

# Запуск нагрузки с 10 задачами, по 500 транзакций каждая
ydb-bench run --jobs 10 --transactions 500

# Запуск нагрузки с 4 клиентскими процессами, 25 задач на процесс
ydb-bench run --process 4 --jobs 25 --transactions 1000

# Запуск с пользовательским скриптом
ydb-bench run --jobs 10 --transactions 100 --file my_script.sql